<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Questionnaire</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: -apple-system, "Helvetica Neue", Helvetica, sans-serif;
      background: #ffffff;
      color: #1a1a1a;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    .container {
      max-width: 560px;
      margin: 0 auto;
      padding: 48px 24px;
      position: relative;
      min-height: 100%;
    }
    .card { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h1 {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.02em;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 14px;
      color: #888;
      margin-bottom: 32px;
    }
    .field {
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #555;
      margin-bottom: 6px;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      outline: none;
      transition: border-color 0.15s;
      font-family: inherit;
      background: #fafafa;
    }
    input:focus {
      border-color: #1a1a1a;
      background: #fff;
    }
    textarea {
      width: 100%;
      padding: 10px 12px;
      font-size: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      outline: none;
      transition: border-color 0.15s;
      font-family: inherit;
      background: #fafafa;
      resize: vertical;
      min-height: 100px;
      line-height: 1.5;
    }
    textarea:focus {
      border-color: #1a1a1a;
      background: #fff;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      font-weight: 500;
      font-family: inherit;
      background: #1a1a1a;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
      margin-top: 8px;
    }
    button:hover { background: #333; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .error {
      color: #c00;
      font-size: 13px;
      margin-bottom: 12px;
    }
    .question-block {
      margin-bottom: 28px;
      padding-bottom: 28px;
      border-bottom: 1px solid #f0f0f0;
    }
    .question-block:last-child {
      border-bottom: none;
    }
    .question-number {
      font-size: 11px;
      font-weight: 600;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }
    .question-text {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .spinner {
      width: 24px; height: 24px;
      border: 2px solid #eee;
      border-top-color: #1a1a1a;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="container" id="app">

  <!-- LOGIN SCREEN -->
  <div class="card" id="loginCard">
    <h1>Steven Lava x GMPI Questionnaire</h1>
    <p class="subtitle">Enter your credentials to begin.</p>
    <div class="field">
      <label for="nameInput">Name</label>
      <input type="text" id="nameInput" autocomplete="name" spellcheck="false">
    </div>
    <div class="field">
      <label for="passInput">Password</label>
      <input type="password" id="passInput">
    </div>
    <div id="loginError" class="error" style="display:none;"></div>
    <button id="loginBtn" onclick="handleLogin()">Log in</button>
  </div>

  <!-- QUESTIONS SCREEN -->
  <div class="card" id="questionCard" style="display:none;">
    <h1 id="qTitle"></h1>
    <p class="subtitle" id="qSubtitle"></p>
    <div id="questionsContainer"></div>
    <div id="submitError" class="error" style="display:none;"></div>
    <button id="submitBtn" onclick="handleSubmit()">Submit</button>
  </div>

  <!-- THANK YOU SCREEN -->
  <div class="card" id="thankYouCard" style="display:none;">
    <h1>Thank you</h1>
    <p class="subtitle">Your responses have been recorded.</p>
    <button onclick="location.reload();" style="margin-top:24px; background:#fff; color:#1a1a1a; border:1px solid #ddd;">Start over</button>
  </div>

  <!-- LOADING OVERLAY -->
  <div id="loadingOverlay" style="display:none;">
    <div class="spinner"></div>
  </div>

</div>

<script>
  // =====================================================
  // PASTE YOUR APPS SCRIPT WEB APP URL BELOW
  // It looks like: https://script.google.com/macros/s/ABC.../exec
  // =====================================================
  var API_URL = 'https://script.google.com/macros/s/AKfycbx22ENaD-tw9iDYz8GIOxrW8ZZOwwqVnwouTdjBExQg1Ith_srk13E_5DaRdKQKT0El/exec';
  // =====================================================

  var userData = {};
  var currentQuestions = [];
  var currentRound = '';

  function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
  }

  // --- API helpers ---

  function apiGet(params) {
    var url = API_URL + '?' + new URLSearchParams(params).toString();
    return fetch(url).then(function(r) { return r.json(); });
  }

  // --- Login ---

  function handleLogin() {
    var name = document.getElementById('nameInput').value.trim();
    var pass = document.getElementById('passInput').value.trim();
    var errEl = document.getElementById('loginError');
    errEl.style.display = 'none';

    if (!name || !pass) {
      errEl.textContent = 'Please enter both name and password.';
      errEl.style.display = 'block';
      return;
    }

    document.getElementById('loginBtn').disabled = true;
    showLoading();

    apiGet({ action: 'authenticate', name: name, password: pass })
      .then(function(result) {
        if (result.success) {
          userData = result;
          loadQuestions();
        } else {
          hideLoading();
          document.getElementById('loginBtn').disabled = false;
          errEl.textContent = 'Invalid name or password.';
          errEl.style.display = 'block';
        }
      })
      .catch(function(err) {
        hideLoading();
        document.getElementById('loginBtn').disabled = false;
        errEl.textContent = 'Something went wrong. Please try again.';
        errEl.style.display = 'block';
      });
  }

  // --- Load questions ---

  function loadQuestions() {
    apiGet({ action: 'round' })
      .then(function(data) {
        currentRound = data.round;
        return apiGet({ action: 'questions', group: userData.group, round: data.round });
      })
      .then(function(data) {
        hideLoading();
        currentQuestions = data.questions;
        renderQuestions(data.questions, currentRound);
      })
      .catch(function(err) {
        hideLoading();
        alert('Failed to load questions. Please refresh and try again.');
      });
  }

  // --- Render questions ---

  function renderQuestions(questions, round) {
    document.getElementById('loginCard').style.display = 'none';
    var card = document.getElementById('questionCard');
    card.style.display = 'block';

    document.getElementById('qTitle').textContent = 'Round ' + round;
    document.getElementById('qSubtitle').textContent = userData.group + ' \u2014 ' + userData.name;

    var container = document.getElementById('questionsContainer');
    container.innerHTML = '';

    if (questions.length === 0) {
      container.innerHTML = '<p style="color:#888; font-size:14px;">No questions found for your group in this round.</p>';
      document.getElementById('submitBtn').style.display = 'none';
      return;
    }

    for (var i = 0; i < questions.length; i++) {
      var block = document.createElement('div');
      block.className = 'question-block';
      block.innerHTML =
        '<div class="question-number">Question ' + (i + 1) + '</div>' +
        '<div class="question-text">' + escapeHtml(questions[i]) + '</div>' +
        '<textarea id="answer_' + i + '" placeholder="Type your answer here\u2026"></textarea>';
      container.appendChild(block);
    }
  }

  function escapeHtml(text) {
    var d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
  }

  // --- Submit ---

  function handleSubmit() {
    var answers = [];
    var errEl = document.getElementById('submitError');
    errEl.style.display = 'none';
    var allFilled = true;

    for (var i = 0; i < currentQuestions.length; i++) {
      var val = document.getElementById('answer_' + i).value.trim();
      if (!val) { allFilled = false; }
      answers.push({ question: currentQuestions[i], answer: val });
    }

    if (!allFilled) {
      errEl.textContent = 'Please answer all questions before submitting.';
      errEl.style.display = 'block';
      return;
    }

    document.getElementById('submitBtn').disabled = true;
    showLoading();

    apiGet({
      action: 'submit',
      data: JSON.stringify({
        name: userData.name,
        group: userData.group,
        round: currentRound,
        answers: answers
      })
    })
      .then(function(result) {
        hideLoading();
        document.getElementById('questionCard').style.display = 'none';
        document.getElementById('thankYouCard').style.display = 'block';
      })
      .catch(function(err) {
        hideLoading();
        document.getElementById('submitBtn').disabled = false;
        errEl.textContent = 'Submission failed. Please try again.';
        errEl.style.display = 'block';
      });
  }

  // Enter key behavior
  document.getElementById('passInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') handleLogin();
  });
  document.getElementById('nameInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') document.getElementById('passInput').focus();
  });
</script>

</body>
</html>
